name: Job Portal Full Stack Deploy

on:
  workflow_run:
    workflows: ['Job Portal Client CI', 'Job Portal Server CI']
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p 22 ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      # -------------------------
      # SETUP SSH
      # -------------------------
      - name: Deploy Server
        run: |
          ssh -p 22 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          set -ex
          # -----------------------------
          # 1️⃣ Source NVM (if using NVM)
          # -----------------------------
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

          # -----------------------------
          # 2️⃣ Debug Node / PM2
          # -----------------------------
          node -v
          npm -v
          pm2 -v

          # -----------------------------
          # 3️⃣ Navigate to server folder
          # -----------------------------
          cd /var/www/job-portal/server
      

          # -----------------------------
          # 5️⃣ Install dependencies
          # -----------------------------
          npm ci --production

          # -----------------------------
          # 6️⃣ Start or reload PM2 process safely
          # -----------------------------
          if pm2 list | grep -q "job-portal-server"; then
              pm2 reload job-portal-server --update-env
          else
              pm2 start server.js --name job-portal-server --update-env
          fi

          # -----------------------------
          # 7️⃣ Optional: view logs for verification
          # -----------------------------
          pm2 save
          EOF
