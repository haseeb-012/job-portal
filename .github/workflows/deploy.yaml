# Workflow name (GitHub Actions UI me show hota hai)
name: CI/CD MERN with Docker Hub

# Workflow kab run ho
on:
  push:
    branches:
      - main   # sirf main branch pe push par trigger

jobs:
  build-and-deploy:
    # GitHub-hosted runner (Linux)
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # 1️⃣ Checkout source code from GitHub repository
      # -------------------------------------------------
      # CI ko code chahiye hota hai taake Docker image build ho sake
      - name: Checkout Code
        uses: actions/checkout@v4

      # -------------------------------------------------
      # 2️⃣ Login to Docker Hub
      # -------------------------------------------------
      # Docker Hub pe image push karne ke liye authentication zaroori
      - name: Docker Hub Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # -------------------------------------------------
      # 3️⃣ Build & Push Backend Docker Image
      # -------------------------------------------------
      # Server folder se Dockerfile read hoti hai
      # Image Docker Hub pe push hoti hai
      - name: Build & Push Backend Image
        run: |
          docker build \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/mern-backend:latest \
            ./server

          docker push \
            ${{ secrets.DOCKERHUB_USERNAME }}/mern-backend:latest

      # -------------------------------------------------
      # 4️⃣ Build & Push Frontend Docker Image (optional)
      # -------------------------------------------------
      # Agar frontend Dockerized hai to yeh step use hota hai
      - name: Build & Push Frontend Image
        run: |
          docker build \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/mern-frontend:latest \
            ./client

          docker push \
            ${{ secrets.DOCKERHUB_USERNAME }}/mern-frontend:latest

      # -------------------------------------------------
      # 5️⃣ Deploy on VPS (CD part)
      # -------------------------------------------------
      # VPS sirf image pull karega, build kabhi nahi
      # Docker Compose se containers restart honge
      - name: Deploy on VPS
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}

          script: |
            # Project directory
            cd /var/www/job-portal

            echo "Pulling latest Docker images from Docker Hub..."
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/mern-backend:latest
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/mern-frontend:latest

            echo "Stopping existing containers..."
            docker compose down

            echo "Starting containers with new images..."
            docker compose up -d

            # Nginx config check (safe reload)
            sudo nginx -t
            sudo systemctl reload nginx
